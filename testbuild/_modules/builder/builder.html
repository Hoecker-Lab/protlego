<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>builder.builder &mdash; ProtLego 1.1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ProtLego
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Code</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../builder.html">Building Chimeras</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../builder.html#module-builder.chimera">Chimera Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../database.html">Fetching hits from Fuzzle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networks.html">Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../energy.html">Energy scoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyse.html">Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyse.html#module-structural.hh_networks">HH-networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyse.html#module-structural.salt_bridges">Salt-bridges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyse.html#module-structural.analysis">Further structural analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html#pip-installation">PIP installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html#conda-installation">CONDA installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html#setup">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html#installing-from-environment-file">Installing from environment file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fuzzle.html">Visit Fuzzle</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction to Jupyter-notebooks and Python primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fetching.html">Fetching from the Fuzzle database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../network.html">Drawing networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../building.html">Building chimeras</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../structural.html">Structural analysis of chimeras</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ProtLego</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">builder.builder</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for builder.builder</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">difflib</span> <span class="kn">import</span> <span class="n">SequenceMatcher</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">protlego.builder.alignments</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">protlego.database.data</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">protlego.builder.AAcodes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">protlego.builder.chimera</span> <span class="kn">import</span> <span class="n">get_SCOP_domain</span><span class="p">,</span> <span class="n">get_FUZZLE_hhs</span>
<span class="kn">from</span> <span class="nn">protlego.builder.chimera</span> <span class="kn">import</span> <span class="n">Chimera</span>

<span class="kn">from</span> <span class="nn">csb.bio.io.hhpred</span> <span class="kn">import</span> <span class="n">HHOutputParser</span>
<span class="kn">from</span> <span class="nn">csb.bio.hmm</span> <span class="kn">import</span> <span class="n">HHpredHitAlignment</span>
<span class="kn">from</span> <span class="nn">moleculekit.molecule</span> <span class="kn">import</span> <span class="n">Molecule</span>
<span class="kn">from</span> <span class="nn">moleculekit.projections.metricrmsd</span> <span class="kn">import</span> <span class="n">MetricRmsd</span>
<span class="kn">from</span> <span class="nn">moleculekit.projections.metricsecondarystructure</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">protlego.definitions</span> <span class="kn">import</span> <span class="n">TM_BIN</span><span class="p">,</span> <span class="n">logger</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="n">aa_keys</span> <span class="o">=</span> <span class="n">special2standard</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">standard_aas</span> <span class="o">=</span> <span class="n">three2one</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

<div class="viewcode-block" id="NotDiverseChimeraError"><a class="viewcode-back" href="../../builder.html#builder.builder.NotDiverseChimeraError">[docs]</a><span class="k">class</span> <span class="nc">NotDiverseChimeraError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="BackboneClashError"><a class="viewcode-back" href="../../builder.html#builder.builder.BackboneClashError">[docs]</a><span class="k">class</span> <span class="nc">BackboneClashError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="BbClashError"><a class="viewcode-back" href="../../builder.html#builder.builder.BbClashError">[docs]</a><span class="k">class</span> <span class="nc">BbClashError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="NotCorrectPDBError"><a class="viewcode-back" href="../../builder.html#builder.builder.NotCorrectPDBError">[docs]</a><span class="k">class</span> <span class="nc">NotCorrectPDBError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="ConnectionGapError"><a class="viewcode-back" href="../../builder.html#builder.builder.ConnectionGapError">[docs]</a><span class="k">class</span> <span class="nc">ConnectionGapError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="Builder"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder">[docs]</a><span class="k">class</span> <span class="nc">Builder</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Graph constructor and visualizer</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    myhit= fetch_id(&#39;10002347&#39;)</span>
<span class="sd">    a=Builder(myhit)</span>
<span class="sd">    aln=a.get_alignment(myhit.query,myhit.no)</span>
<span class="sd">    qPDB, sPDB = a.superimpose_structures(aln,partial_alignment=True)        </span>
<span class="sd">    chimeras=a.build_chimeras(partial_alignment=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hit</span><span class="p">:</span> <span class="n">Hit</span><span class="p">):</span>
        <span class="n">qpdb_path</span> <span class="o">=</span> <span class="n">get_SCOP_domain</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">spdb_path</span> <span class="o">=</span> <span class="n">get_SCOP_domain</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">sbjct</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading </span><span class="si">{</span><span class="n">qpdb_path</span><span class="si">}</span><span class="s1"> as a chimera object&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">qPDB</span> <span class="o">=</span> <span class="n">Chimera</span><span class="p">(</span><span class="n">qpdb_path</span><span class="p">,</span> <span class="n">validateElements</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">qpdb_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qPDB</span><span class="o">.</span><span class="n">numFrames</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qPDB</span><span class="o">.</span><span class="n">dropFrames</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Query protein contains more than one model. Keeping only the first one&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading </span><span class="si">{</span><span class="n">spdb_path</span><span class="si">}</span><span class="s1"> as a chimera object&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sPDB</span> <span class="o">=</span> <span class="n">Chimera</span><span class="p">(</span><span class="n">spdb_path</span><span class="p">,</span> <span class="n">validateElements</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">spdb_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sPDB</span><span class="o">.</span><span class="n">numFrames</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sPDB</span><span class="o">.</span><span class="n">dropFrames</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subject protein contains more than one model. Keeping only the first one&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qaPDB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saPDB</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qpairs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spairs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Builder.get_alignment"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder.get_alignment">[docs]</a>    <span class="k">def</span> <span class="nf">get_alignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">no</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HHpredHitAlignment</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Obtain the HHS alignment &#39;no&#39; for query &#39;query&#39;.</span>
<span class="sd">        Only the alignment from the fragment region is retrieved.</span>
<span class="sd">        This implies that when the fragment is not located in the</span>
<span class="sd">        N-terminus hit.q_start and the position in the output won&#39;t</span>
<span class="sd">        be the same. For example, if q_start = 20, that aminoacid is</span>
<span class="sd">        in position 0 in aln.query.</span>

<span class="sd">        :param query: str. Domain query</span>
<span class="sd">        :param no: int. Specifies the position in the file (alignment with subject)</span>

<span class="sd">        :return: HHpredHitAlignment. Alignment between query and subject for the fragment region.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hhF</span> <span class="o">=</span> <span class="n">get_FUZZLE_hhs</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hh</span> <span class="o">=</span> <span class="n">HHOutputParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">hhF</span><span class="p">)</span>
            <span class="n">pair</span> <span class="o">=</span> <span class="n">hh</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">no</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">aln</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">alignment</span>
            <span class="k">return</span> <span class="n">aln</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsing of </span><span class="si">{</span><span class="n">hhF</span><span class="si">}</span><span class="s2"> failed. Error follows: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Builder.remove_residue"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder.remove_residue">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_residue</span><span class="p">(</span><span class="n">pdb</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">,</span> <span class="n">resid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes a specific residue by its name</span>
<span class="sd">        :param pdb: The pdb to mutate the residues to</span>
<span class="sd">        :param resid:</span>
<span class="sd">        :return: The pdb with the filtered residues</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pdb</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;not </span><span class="si">{</span><span class="n">resid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pdb</span></div>

<div class="viewcode-block" id="Builder.find_nonstandards"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder.find_nonstandards">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_nonstandards</span><span class="p">(</span><span class="n">pdb</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds non-standard aminoacids</span>
<span class="sd">        :param pdb: Molecule or Chimera object where to find non-standard aminoacids.</span>
<span class="sd">        :return: list of non-standard residues</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">non_standards</span> <span class="o">=</span> <span class="p">[</span><span class="n">aa</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pdb</span><span class="o">.</span><span class="n">resname</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">aa</span> <span class="ow">in</span> <span class="n">aa_keys</span> <span class="ow">or</span> <span class="n">aa</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">standard_aas</span><span class="p">)]</span>
        <span class="c1">#ns_resid =  [for id in pdb.resid]</span>
        <span class="k">if</span> <span class="n">non_standards</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">non_standards</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s1">&#39;UNK&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found the following non-standard residue: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;Preserving in the original PDB&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Protein presents unknown residue UNK.&quot;</span>
                                   <span class="s2">&quot; Call remove_residue() to remove it or provide parameters&quot;</span>
                                   <span class="s2">&quot; if you want to minimize it with AMBER or CHARMM.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">non_standards</span></div>

<div class="viewcode-block" id="Builder.mutate_nonstandards"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder.mutate_nonstandards">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">mutate_nonstandards</span><span class="p">(</span><span class="n">pdb</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecule</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param pdb: The pdb to mutate the residues to</span>
<span class="sd">        :return: The pdb with the mutated residues -if there are any-</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">non_standards</span> <span class="o">=</span> <span class="n">Builder</span><span class="o">.</span><span class="n">find_nonstandards</span><span class="p">(</span><span class="n">pdb</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">non_standards</span><span class="p">:</span>
            <span class="p">[</span><span class="n">pdb</span><span class="o">.</span><span class="n">mutateResidue</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;resname </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">special2standard</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">non_standards</span><span class="p">]</span>
        <span class="c1">#else :</span>
        <span class="c1">#    remove_residue(pdb, resid)</span>

        <span class="k">return</span> <span class="n">pdb</span></div>

<div class="viewcode-block" id="Builder.seq2pdbaln"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder.seq2pdbaln">[docs]</a>    <span class="k">def</span> <span class="nf">seq2pdbaln</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pdb</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Obtains the resid (positions in the PDB) of the aminoacids involved in the fragment.</span>

<span class="sd">        :param sequence: str. sequence of the fragment</span>
<span class="sd">        :param pdb: Molecule. PDB from where to obtain the residues</span>
<span class="sd">        :return: mapping. The the PDB Positions of the fragment. A List of tuples of the form: (sequence aminoacid, pdb resid)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Mutate non standard residues</span>
        <span class="n">copy_pdb</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># making a copy to ensure the possible mutations don&#39;t affect the pdb</span>
        <span class="n">copy_pdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutate_nonstandards</span><span class="p">(</span><span class="n">copy_pdb</span><span class="p">)</span>

        <span class="c1"># Mapping of residue to number</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pdb_sequence</span> <span class="o">=</span> <span class="n">copy_pdb</span><span class="o">.</span><span class="n">sequence</span><span class="p">()[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotCorrectPDBError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDB structure from protein </span><span class="si">{</span><span class="n">pdb</span><span class="o">.</span><span class="n">viewname</span><span class="si">}</span><span class="s2"> not correct&quot;</span><span class="p">)</span>

        <span class="n">copy_pdb</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># second copy to preserve indexing</span>
        <span class="n">pdb_indices</span> <span class="o">=</span> <span class="n">copy_pdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;protein and name CA&quot;</span><span class="p">)</span>

        <span class="c1"># sequence from the HHS alignment (fragment)</span>
        <span class="n">seq_positions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">]</span>

        <span class="c1"># obtain mapping</span>
        <span class="n">matcher</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">pdb_sequence</span><span class="p">,</span> <span class="n">autojunk</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">matcher</span><span class="o">.</span><span class="n">get_matching_blocks</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">block</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">seq_positions</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pdb_indices</span><span class="p">[</span><span class="n">block</span><span class="o">.</span><span class="n">b</span> <span class="o">+</span> <span class="n">i</span><span class="p">],)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">seq_positions</span></div>

    <span class="k">def</span> <span class="nf">_get_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aln</span><span class="p">:</span> <span class="n">HHpredHitAlignment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Obtain the positions of the pdb which are present in both alignments.</span>
<span class="sd">        Thus the number of atoms is the same</span>

<span class="sd">        :param aln: HHpredHitAlignment. The fragment sequence alignment</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">qpairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">preqpairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prespairs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Obtain the corresponding PDB residues to the fragment seq. alignment</span>
        <span class="n">query_seq2pdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq2pdbaln</span><span class="p">(</span><span class="n">aln</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qPDB</span><span class="p">)</span>
        <span class="n">sbjct_seq2pdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq2pdbaln</span><span class="p">(</span><span class="n">aln</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sPDB</span><span class="p">)</span>
        
        <span class="c1"># Retrieving correct residue sequence numbers for each aligned position</span>
        <span class="c1"># i.e positions that both query and subject contain aminoacids</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">resi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aln</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># the first residue in HHpredHitAlignment is 1</span>
            <span class="k">if</span> <span class="n">aln</span><span class="o">.</span><span class="n">gap_at</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_seq2pdb</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sbjct_seq2pdb</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">preqpairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query_seq2pdb</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">prespairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sbjct_seq2pdb</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># then this corresponds to a partial-alignment chunk and we can save it</span>
                <span class="k">if</span> <span class="n">preqpairs</span><span class="p">:</span>
                    <span class="n">qpairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preqpairs</span><span class="p">)</span>
                    <span class="n">spairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prespairs</span><span class="p">)</span>
                    <span class="n">preqpairs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">prespairs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">preqpairs</span><span class="p">:</span>
            <span class="n">qpairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preqpairs</span><span class="p">)</span>
            <span class="n">spairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prespairs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qpairs</span> <span class="o">=</span> <span class="n">qpairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spairs</span> <span class="o">=</span> <span class="n">spairs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">global_qpairs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">item</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">qpairs</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_spairs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">item</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">spairs</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">]]</span>



<div class="viewcode-block" id="Builder.superimpose_structures"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder.superimpose_structures">[docs]</a>    <span class="k">def</span> <span class="nf">superimpose_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aln</span><span class="p">:</span> <span class="n">HHpredHitAlignment</span><span class="p">,</span> <span class="n">partial_alignment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Moves the two molecules to the origin of coordinates.</span>
<span class="sd">            Aligns the full structures according the fragment and obtains RMSDs and distances.</span>

<span class="sd">        :param qpairs: List of CA to be aligned in the query structure</span>
<span class="sd">        :param spairs: List of CA to be aligned in the subject structure</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_pairs</span><span class="p">(</span><span class="n">aln</span><span class="p">)</span>

        <span class="c1"># Re-align if command is called twice</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qaPDB</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qaPDB</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saPDB</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dst</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">partial_alignment</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">qpairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_qpairs</span>
            <span class="n">spairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_spairs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qpairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpairs</span>
            <span class="n">spairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spairs</span>

        <span class="c1"># Print info if the alignment was intended partial but there&#39;s only one chunk</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpairs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">partial_alignment</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The sequence alignment only contains one chunk. Performing global alignment&quot;</span><span class="p">)</span>

        <span class="c1"># We only need one query, center to the origin of coordinates.</span>
        <span class="c1"># It is the subject that aligns to this template.</span>
        <span class="n">qmol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qPDB</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">smol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sPDB</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">qmol</span><span class="o">.</span><span class="n">center</span><span class="p">()</span>
        <span class="n">smol</span><span class="o">.</span><span class="n">center</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qaPDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">qmol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">qpair_chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qpairs</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performing alignment </span><span class="si">{</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> with TMalign&quot;</span><span class="p">)</span>
            <span class="n">saPDB</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_superimpose_chunk</span><span class="p">(</span><span class="n">qpair_chunk</span><span class="p">,</span> <span class="n">spairs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">qmol</span><span class="p">,</span> <span class="n">smol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saPDB</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">saPDB</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">global_dst</span> <span class="o">=</span> <span class="p">[[</span><span class="n">item</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dst</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">]]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qaPDB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saPDB</span></div>

    <span class="k">def</span> <span class="nf">_superimpose_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">spairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">qmol</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">,</span> <span class="n">smol</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Molecule</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Superimposes the part of the total sequence alignment defined</span>
<span class="sd">        by the indexes qpairs/spairs</span>
<span class="sd">        :param qpairs: list of indexes to align from the pdb query</span>
<span class="sd">        :param spairs: list of indexes to align from the pdb subject</span>
<span class="sd">        :param qmol: the query pdb</span>
<span class="sd">        :param smol: the subject pdb</span>
<span class="sd">        :return: smol: the subject molecule aligned.</span>
<span class="sd">                distances: a list of the distances between the alpha Carbons after alignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Copying because we are going to cut the pdbs into the chunks</span>
        <span class="n">copyq</span> <span class="o">=</span> <span class="n">qmol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">copys</span> <span class="o">=</span> <span class="n">smol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">copyq</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;protein and backbone and same residue as index </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">qpairs</span><span class="p">)))</span>
        <span class="n">copys</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;protein and backbone and same residue as index </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">spairs</span><span class="p">)))</span>
        <span class="n">copyq</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;/tmp/copyq.pdb&#39;</span><span class="p">)</span>
        <span class="n">copys</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;/tmp/copys.pdb&#39;</span><span class="p">)</span>

        <span class="c1"># Matrix for VMD</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># We align subject onto the query</span>
            <span class="n">tm_matrix</span> <span class="o">=</span> <span class="n">get_tmalign_output</span><span class="p">(</span><span class="s1">&#39;/tmp/copys.pdb&#39;</span><span class="p">,</span> <span class="s1">&#39;/tmp/copyq.pdb&#39;</span><span class="p">,</span> <span class="s2">&quot;matrix&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ChildProcessError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TMalign cannot align the PDBs. Error follows: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">vectran</span><span class="p">,</span> <span class="n">matrot</span> <span class="o">=</span> <span class="n">tm2vmd</span><span class="p">(</span><span class="n">tm_matrix</span><span class="p">)</span>

        <span class="c1"># remove copy files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/copyq.pdb&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/copys.pdb&#39;</span><span class="p">)</span>

        <span class="c1"># align the whole subject domain and fragment.</span>
        <span class="c1"># Copying so that the original smol does not lose the origin of coordinates</span>
        <span class="n">s1mol</span> <span class="o">=</span> <span class="n">smol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">s1mol</span><span class="o">.</span><span class="n">rotateBy</span><span class="p">(</span><span class="n">matrot</span><span class="p">)</span>
        <span class="n">s1mol</span><span class="o">.</span><span class="n">moveBy</span><span class="p">(</span><span class="n">vectran</span><span class="p">)</span>
        <span class="n">copys</span><span class="o">.</span><span class="n">rotateBy</span><span class="p">(</span><span class="n">matrot</span><span class="p">)</span>
        <span class="n">copys</span><span class="o">.</span><span class="n">moveBy</span><span class="p">(</span><span class="n">vectran</span><span class="p">)</span>

        <span class="c1"># Compute RMSD for the fragments</span>
        <span class="n">rmsd</span> <span class="o">=</span> <span class="n">MetricRmsd</span><span class="p">(</span><span class="n">copyq</span><span class="p">,</span> <span class="s1">&#39;protein and name CA&#39;</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">rmsd</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">copys</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The RMSD between the fragments is </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2"> over </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">spairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> alpha carbons&quot;</span><span class="p">)</span>

        <span class="c1"># Compute distances between the two selections</span>
        <span class="n">bbq</span> <span class="o">=</span> <span class="n">copyq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coords&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;protein and name CA&quot;</span><span class="p">)</span>
        <span class="n">bbs</span> <span class="o">=</span> <span class="n">copys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coords&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;protein and name CA&quot;</span><span class="p">)</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">cdist</span><span class="p">(</span><span class="n">bbq</span><span class="p">,</span> <span class="n">bbs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s1mol</span><span class="p">,</span> <span class="n">distances</span>

    <span class="k">def</span> <span class="nf">_construct_chimera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qmol</span><span class="p">,</span> <span class="n">smol</span><span class="p">,</span> <span class="n">qstart</span><span class="p">,</span> <span class="n">qend</span><span class="p">,</span> <span class="n">sstart</span><span class="p">,</span> <span class="n">send</span><span class="p">,</span> <span class="n">combination</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param qmol: Molecule. The query protein</span>
<span class="sd">        :param smol: Molecule. The subject protein in any of its positions</span>
<span class="sd">        :param qstart: int. Position to start the cut in the query</span>
<span class="sd">        :param qend: int. Position to end the cut in the query</span>
<span class="sd">        :param sstart: int. Position to start the cut in the sbjct</span>
<span class="sd">        :param send: int. Position to end the cut in the sbjct.</span>
<span class="sd">        :return: Molecule, DataFrame Objects.</span>
<span class="sd">        chim1: The resulting chimera</span>
<span class="sd">        mapping: The mapping from the old residue numbering to the new one</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qmol_copy</span> <span class="o">=</span> <span class="n">qmol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">smol_copy</span> <span class="o">=</span> <span class="n">smol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">qmol_copy</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(protein and same residue as index &#39;</span><span class="si">{</span><span class="n">qstart</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">qend</span><span class="si">}</span><span class="s2">&#39;)</span><span class="se">\</span>
<span class="s2">         or (not protein and same residue as within 4 of protein and same residue as index &#39;</span><span class="si">{</span><span class="n">qstart</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">qend</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
        <span class="n">smol_copy</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(protein and same residue as index &#39;</span><span class="si">{</span><span class="n">sstart</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">send</span><span class="si">}</span><span class="s2">&#39;)</span><span class="se">\</span>
<span class="s2">         or (not protein and same residue as within 4 of protein and same residue as index &#39;</span><span class="si">{</span><span class="n">qstart</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">qend</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
        <span class="c1"># Avoid chimeras that only have a few mutations from</span>
        <span class="c1"># one of the parents</span>
        <span class="n">qmol_resid</span> <span class="o">=</span> <span class="n">qmol_copy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;protein and name CA&quot;</span><span class="p">)</span>
        <span class="n">smol_resid</span> <span class="o">=</span> <span class="n">smol_copy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;protein and name CA&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qmol_resid</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">or</span> <span class="n">smol_resid</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotDiverseChimeraError</span>

        <span class="n">bbq</span> <span class="o">=</span> <span class="n">qmol_copy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coords&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;protein and backbone&quot;</span><span class="p">)</span>
        <span class="n">bbs</span> <span class="o">=</span> <span class="n">smol_copy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coords&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;protein and backbone&quot;</span><span class="p">)</span>

        <span class="n">distances</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">bbq</span><span class="p">,</span> <span class="n">bbs</span><span class="p">)</span>
        <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">distances</span> <span class="o">&lt;</span> <span class="mf">1.3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx1</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">idx2</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">BackboneClashError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chim1</span> <span class="o">=</span> <span class="n">Chimera</span><span class="p">()</span>
            <span class="n">qmol_copy</span><span class="o">.</span><span class="n">renumberResidues</span><span class="p">()</span>
            <span class="n">smol_copy</span><span class="o">.</span><span class="n">renumberResidues</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">combination</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">last_id</span> <span class="o">=</span> <span class="n">smol_resid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">new_ids</span> <span class="o">=</span> <span class="n">get_new_resIDs</span><span class="p">(</span><span class="n">qmol_copy</span><span class="p">,</span> <span class="n">last_id</span><span class="p">)</span>
                <span class="n">qmol_copy</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="n">new_ids</span><span class="p">)</span>
                <span class="n">chim1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smol_copy</span><span class="p">)</span>
                <span class="n">chim1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qmol_copy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">last_id</span> <span class="o">=</span> <span class="n">qmol_resid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">new_ids</span> <span class="o">=</span> <span class="n">get_new_resIDs</span><span class="p">(</span><span class="n">smol_copy</span><span class="p">,</span> <span class="n">last_id</span><span class="p">)</span>
                <span class="n">smol_copy</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="n">new_ids</span><span class="p">)</span>
                <span class="n">chim1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qmol_copy</span><span class="p">)</span>
                <span class="n">chim1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smol_copy</span><span class="p">)</span>
            <span class="n">chim1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chim1</span><span class="p">,</span> <span class="n">last_id</span>

<div class="viewcode-block" id="Builder.build_recomb"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder.build_recomb">[docs]</a>    <span class="k">def</span> <span class="nf">build_recomb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partial_alignment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cutoff_distance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Chimera</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot; Build all possible chimeras between the two proteins that fulfill</span>
<span class="sd">        these two criteria:</span>
<span class="sd">        1) That the distance between the fusion points is below the cutoff distance</span>
<span class="sd">        2) That the resulting chimera does not present any backbone clashes</span>

<span class="sd">        :return: A dictionary with all the possible chimeras</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You need to align the structures before building the chimeras&quot;</span><span class="p">)</span>

        <span class="n">chimeras</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">outcomes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Query N-terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;Subject N-terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;Not enough mutations Query N-terminal&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Not enough mutations Subject N-terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;Backbone clash&#39;</span><span class="p">]</span>
        <span class="c1">#outcomes = [&#39;Query N-terminal&#39;, &#39;Subject N-terminal&#39;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">outcomes</span><span class="p">,</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">))]))</span>

        <span class="n">q_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qPDB</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;protein and name CA&quot;</span><span class="p">)</span>
        <span class="n">qstart</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">q_indices</span><span class="p">)</span>
        <span class="n">qend</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">q_indices</span><span class="p">)</span>

        <span class="n">s_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sPDB</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;protein and name CA&quot;</span><span class="p">)</span>
        <span class="n">sstart</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">s_indices</span><span class="p">)</span>
        <span class="n">send</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">s_indices</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">partial_alignment</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">qpairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_qpairs</span>
            <span class="n">spairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_spairs</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_dst</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qpairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpairs</span>
            <span class="n">spairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spairs</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dst</span>

        <span class="c1"># Get the positions in the fragment closer than the cutoff</span>
        <span class="k">for</span> <span class="n">aln_index</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">aln_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saPDB</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alignment </span><span class="si">{</span><span class="n">aln_index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> was not produced. Skipping to next alignment.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">fusion_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">cutoff_distance</span><span class="p">]</span>

            <span class="c1">#print(fusion_points)</span>
            <span class="c1"># Build query-subject chimera</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">fusion_points</span><span class="p">:</span>
                <span class="n">qMOL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qaPDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">sMOL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saPDB</span><span class="p">[</span><span class="n">aln_index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">xo_query</span> <span class="o">=</span> <span class="n">qpairs</span><span class="p">[</span><span class="n">aln_index</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">xo_subject</span> <span class="o">=</span> <span class="n">spairs</span><span class="p">[</span><span class="n">aln_index</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">xo_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_qpairs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">number</span> <span class="o">==</span> <span class="n">xo_query</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qPDB</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;index </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_qpairs</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="n">xo_resid</span> <span class="o">=</span> <span class="n">residues</span><span class="p">[</span><span class="n">xo_index</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xo_query_1</span> <span class="o">=</span> <span class="n">qpairs</span><span class="p">[</span><span class="n">aln_index</span><span class="p">][</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">xo_subject_1</span> <span class="o">=</span> <span class="n">spairs</span><span class="p">[</span><span class="n">aln_index</span><span class="p">][</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># Position corresponds to C-terminus limit of the fragment</span>
                    <span class="n">xo_query_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">qindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">q_indices</span><span class="p">)</span> <span class="k">if</span> <span class="n">qindex</span> <span class="o">==</span> <span class="n">xo_query</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">xo_subject_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_indices</span><span class="p">)</span> <span class="k">if</span> <span class="n">sindex</span> <span class="o">==</span> <span class="n">xo_subject</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Combination query-subject</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chimera1</span><span class="p">,</span> <span class="n">xo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_chimera</span><span class="p">(</span><span class="n">qMOL</span><span class="p">,</span> <span class="n">sMOL</span><span class="p">,</span> <span class="n">qstart</span><span class="p">,</span> <span class="n">xo_query</span><span class="p">,</span>
                                                           <span class="n">xo_subject_1</span><span class="p">,</span> <span class="n">send</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Query N-terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xo_query</span><span class="p">)</span>
                    <span class="n">chimeras</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;comb1_</span><span class="si">{</span><span class="n">xo_resid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chimera1</span>
                    <span class="n">chimeras</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;comb1_</span><span class="si">{</span><span class="n">xo_resid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_crossover</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">NotDiverseChimeraError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Not enough mutations Query N-terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xo_query</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BackboneClashError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Backbone clash&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xo_query</span><span class="p">)</span>

                <span class="c1"># Combination subject-query</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chimera2</span><span class="p">,</span> <span class="n">xo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_chimera</span><span class="p">(</span><span class="n">qMOL</span><span class="p">,</span> <span class="n">sMOL</span><span class="p">,</span> <span class="n">xo_query_1</span><span class="p">,</span> <span class="n">qend</span><span class="p">,</span>
                                                           <span class="n">sstart</span><span class="p">,</span> <span class="n">xo_subject</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Subject N-terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xo_query</span><span class="p">)</span>
                    <span class="n">chimeras</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;comb2_</span><span class="si">{</span><span class="n">xo_resid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chimera2</span>
                    <span class="n">chimeras</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;comb2_</span><span class="si">{</span><span class="n">xo_resid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_crossover</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">NotDiverseChimeraError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Not enough mutations Subject N-terminal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xo_query</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BackboneClashError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Backbone clash&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xo_query</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">chimeras</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No combination of query and subject produced a chimera that matched the criteria&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chimeras</span></div>

<div class="viewcode-block" id="Builder.plot_curves"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder.plot_curves">[docs]</a>    <span class="k">def</span> <span class="nf">plot_curves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plots the distance between the alpha carbons in the structure for the fragment region along with the number of backbone clashes of the resulting chimera for each position</span>

<span class="sd">        :param dst: np.ndarray: an array containign the distance for each fragment position</span>
<span class="sd">        :param bbContacts1: an array containing the number of bb contacts for each fragment position for the resulting chimera of combination query-subject</span>
<span class="sd">        :param bbContacts2: an array containing the number of bb contacts for each fragment position for the resulting chimera of combination subject - query</span>
<span class="sd">        </span>
<span class="sd">        :return: a matplotlib.pyplot figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You need to build the chimeras before plotting. Call build_chimeras()&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_dst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qPDB</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;index </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_qpairs</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

        <span class="n">resids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">resids</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qPDB</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;index </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resids</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">resids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">resi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">residues</span><span class="p">)</span> <span class="k">if</span> <span class="n">resi</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
                <span class="n">distances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">distance</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">distances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">color</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;#FCB711&#39;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;#CC004C&#39;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">resids</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">color</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;distance q-s&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Residue in the fragment relative to domain </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Distance ($\AA$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resids</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">distances</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">colors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Builder.check_connection_gap"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder.check_connection_gap">[docs]</a>    <span class="k">def</span> <span class="nf">check_connection_gap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol1</span><span class="p">,</span> <span class="n">mol2</span><span class="p">,</span> <span class="n">mol3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c1to2</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol1</span><span class="p">,</span> <span class="n">mol2</span><span class="p">]</span>
        <span class="n">c2to3</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol2</span><span class="p">,</span> <span class="n">mol3</span><span class="p">]</span>

        <span class="n">lsts</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1to2</span><span class="p">,</span> <span class="n">c2to3</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">lsts</span><span class="p">:</span>
            <span class="n">lastC</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coords&#39;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s1">&#39;protein and name C&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">firstN</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coords&#39;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s1">&#39;protein and name N&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lastC</span> <span class="o">-</span> <span class="n">firstN</span><span class="p">)</span>
            <span class="c1"># print(dist)</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;=</span> <span class="mf">1.34</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConnectionGapError</span></div>


<div class="viewcode-block" id="Builder.check_bb_clashes"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder.check_bb_clashes">[docs]</a>    <span class="k">def</span> <span class="nf">check_bb_clashes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chim_mol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param chim_mol:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">chim_mol</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">chim_mol</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">matrix</span> <span class="o">&lt;</span> <span class="mf">1.3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx1</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">idx2</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">BackboneClashError</span></div>

    <span class="k">def</span> <span class="nf">catch_bb_clashes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chim_mol</span><span class="p">,</span> <span class="n">mol_1</span><span class="p">,</span> <span class="n">mol_2</span><span class="p">,</span> <span class="n">mol_3</span><span class="p">):</span>

        <span class="n">mol_1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s2">&quot;protein and backbone&quot;</span><span class="p">)</span>
        <span class="n">mol_2</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s2">&quot;protein and backbone&quot;</span><span class="p">)</span>
        <span class="n">mol_3</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s2">&quot;protein and backbone&quot;</span><span class="p">)</span>

        <span class="n">matrix</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">mol_1</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mol_2</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">matrix</span> <span class="o">&lt;</span> <span class="mf">1.3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx1</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">idx2</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">BbClashError</span>

        <span class="c1">#matrix = cdist(mol_1.coords[:, :, 0], mol_3.coords[:, :, 0])</span>
        <span class="c1">#idx1, idx2 = np.where(matrix &lt; 1.3)</span>
        <span class="c1">#if idx1.any() or idx2.any():</span>
        <span class="c1">#    raise BbClashError</span>

        <span class="n">matrix</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">mol_2</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mol_3</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">matrix</span> <span class="o">&lt;</span> <span class="mf">1.3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx1</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">idx2</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">BbClashError</span>

    <span class="k">def</span> <span class="nf">format_serials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">record</span><span class="p">):</span>
            <span class="n">mol</span><span class="o">.</span><span class="n">serial</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">mol</span>

    <span class="k">def</span> <span class="nf">format_molparts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qmol_1</span><span class="p">,</span> <span class="n">qmol_2</span><span class="p">,</span> <span class="n">qmol_3</span><span class="p">,</span> <span class="n">smol_1</span><span class="p">,</span> <span class="n">smol_2</span><span class="p">,</span> <span class="n">smol_3</span><span class="p">):</span>

        <span class="n">qsq_chim</span> <span class="o">=</span> <span class="p">[</span><span class="n">qmol_1</span><span class="p">,</span> <span class="n">smol_2</span><span class="p">,</span> <span class="n">qmol_3</span><span class="p">]</span>
        <span class="n">sqs_chim</span> <span class="o">=</span> <span class="p">[</span><span class="n">smol_1</span><span class="p">,</span> <span class="n">qmol_2</span><span class="p">,</span> <span class="n">smol_3</span><span class="p">]</span>
        <span class="n">both_chim</span> <span class="o">=</span> <span class="p">[</span><span class="n">qsq_chim</span><span class="p">,</span> <span class="n">sqs_chim</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">one_chim</span> <span class="ow">in</span> <span class="n">both_chim</span><span class="p">:</span>
            <span class="n">last_resid</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ser</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">one_chim</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">record</span><span class="p">):</span>
                    <span class="n">mol</span><span class="o">.</span><span class="n">resid</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">last_resid</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">mol</span><span class="o">.</span><span class="n">serial</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser</span>
                    <span class="n">ser</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">last_resid</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">resid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">qmol_1</span><span class="p">,</span> <span class="n">qmol_2</span><span class="p">,</span> <span class="n">qmol_3</span><span class="p">,</span> <span class="n">smol_1</span><span class="p">,</span> <span class="n">smol_2</span><span class="p">,</span> <span class="n">smol_3</span>

    <span class="k">def</span> <span class="nf">_construct_recombination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qmol</span><span class="p">,</span> <span class="n">smol</span><span class="p">,</span> <span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">,</span>
                                 <span class="n">xo_query_1</span><span class="p">,</span> <span class="n">xo_query_2</span><span class="p">,</span>
                                 <span class="n">xo_subject_1</span><span class="p">,</span> <span class="n">xo_subject_2</span><span class="p">,</span> <span class="n">combnum</span><span class="p">):</span>

        <span class="n">qmol_1</span> <span class="o">=</span> <span class="n">qmol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">qmol_2</span> <span class="o">=</span> <span class="n">qmol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">qmol_3</span> <span class="o">=</span> <span class="n">qmol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">smol_1</span> <span class="o">=</span> <span class="n">smol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">smol_2</span> <span class="o">=</span> <span class="n">smol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">smol_3</span> <span class="o">=</span> <span class="n">smol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">qstart</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">qmol</span><span class="o">.</span><span class="n">serial</span><span class="p">)</span>
        <span class="n">qend</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">qmol</span><span class="o">.</span><span class="n">serial</span><span class="p">)</span>
        <span class="n">sstart</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">smol</span><span class="o">.</span><span class="n">serial</span><span class="p">)</span>
        <span class="n">send</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">smol</span><span class="o">.</span><span class="n">serial</span><span class="p">)</span>

        <span class="c1">## Query fractioning</span>
        <span class="n">qmol_1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;protein and same residue as index &#39;</span><span class="si">{</span><span class="n">qstart</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">xo_query_1</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
        <span class="c1">## Getting first residue after xo_query_1</span>
        <span class="n">next_xo_q_1</span> <span class="o">=</span> <span class="n">qmol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;protein and resid </span><span class="si">{</span><span class="n">qmol_1</span><span class="o">.</span><span class="n">resid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># qmol_2.filter(f&quot;protein and same residue as index &#39;{xo_query_1}&#39; to &#39;{xo_query_2}&#39;&quot;);</span>
        <span class="n">qmol_2</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;protein and same residue as index &#39;</span><span class="si">{</span><span class="n">next_xo_q_1</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">xo_query_2</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">);</span>

        <span class="c1">## Getting first residue after xo_query_2</span>
        <span class="n">next_xo_q_2</span> <span class="o">=</span> <span class="n">qmol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;protein and resid </span><span class="si">{</span><span class="n">qmol_2</span><span class="o">.</span><span class="n">resid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># qmol_3.filter(f&quot;protein and same residue as index &#39;{xo_query_2}&#39; to &#39;{qend}&#39;&quot;);</span>
        <span class="n">qmol_3</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;protein and same residue as index &#39;</span><span class="si">{</span><span class="n">next_xo_q_2</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">qend</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">);</span>

        <span class="c1">## Subject fractioning</span>
        <span class="n">smol_1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;protein and same residue as index &#39;</span><span class="si">{</span><span class="n">sstart</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">xo_subject_1</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
        <span class="c1">## Getting first residue after xo_subject_1</span>
        <span class="n">next_xo_s_1</span> <span class="o">=</span> <span class="n">smol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;protein and resid </span><span class="si">{</span><span class="n">smol_1</span><span class="o">.</span><span class="n">resid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">smol_2</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;protein and same residue as index &#39;</span><span class="si">{</span><span class="n">next_xo_s_1</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">xo_subject_2</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
        <span class="c1">## Getting first residue after xo_subject_2</span>
        <span class="n">next_xo_s_2</span> <span class="o">=</span> <span class="n">smol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;protein and resid </span><span class="si">{</span><span class="n">smol_2</span><span class="o">.</span><span class="n">resid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">smol_3</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;protein and same residue as index &#39;</span><span class="si">{</span><span class="n">next_xo_s_2</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">send</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">);</span>

        <span class="n">qmol_1</span><span class="o">.</span><span class="n">renumberResidues</span><span class="p">()</span>
        <span class="n">qmol_2</span><span class="o">.</span><span class="n">renumberResidues</span><span class="p">()</span>
        <span class="n">qmol_3</span><span class="o">.</span><span class="n">renumberResidues</span><span class="p">()</span>

        <span class="n">smol_1</span><span class="o">.</span><span class="n">renumberResidues</span><span class="p">()</span>
        <span class="n">smol_2</span><span class="o">.</span><span class="n">renumberResidues</span><span class="p">()</span>
        <span class="n">smol_3</span><span class="o">.</span><span class="n">renumberResidues</span><span class="p">()</span>

        <span class="n">qmol_1</span><span class="p">,</span> <span class="n">qmol_2</span><span class="p">,</span> <span class="n">qmol_3</span><span class="p">,</span> <span class="n">smol_1</span><span class="p">,</span> <span class="n">smol_2</span><span class="p">,</span> <span class="n">smol_3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_molparts</span><span class="p">(</span><span class="n">qmol_1</span><span class="p">,</span> <span class="n">qmol_2</span><span class="p">,</span> <span class="n">qmol_3</span><span class="p">,</span> <span class="n">smol_1</span><span class="p">,</span> <span class="n">smol_2</span><span class="p">,</span>
                                                                              <span class="n">smol_3</span><span class="p">)</span>

        <span class="n">chim</span> <span class="o">=</span> <span class="n">Chimera</span><span class="p">()</span>
        <span class="n">chim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qmol_1</span><span class="p">)</span>
        <span class="n">chim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smol_2</span><span class="p">)</span>
        <span class="n">chim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qmol_3</span><span class="p">)</span>

        <span class="c1">#try:</span>
        <span class="c1">#    self.check_connection_gap(qmol_1, smol_2, qmol_3)</span>
        <span class="c1">#except ConnectionGapError:</span>
        <span class="c1">#    logger.warning(f&quot;comb{combnum}_{index1}_{index2} present ConnectionGapError&quot;)</span>
        <span class="c1">#    raise ConnectionGapError</span>

        <span class="n">chim</span><span class="o">.</span><span class="n">reps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;protein and same residue as index &#39;</span><span class="si">{</span><span class="n">qmol_1</span><span class="o">.</span><span class="n">serial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">qmol_1</span><span class="o">.</span><span class="n">serial</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                      <span class="n">style</span><span class="o">=</span><span class="s1">&#39;NewCartoon&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">chim</span><span class="o">.</span><span class="n">reps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;protein and same residue as index &#39;</span><span class="si">{</span><span class="n">smol_2</span><span class="o">.</span><span class="n">serial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">smol_2</span><span class="o">.</span><span class="n">serial</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                      <span class="n">style</span><span class="o">=</span><span class="s1">&#39;NewCartoon&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">chim</span><span class="o">.</span><span class="n">reps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;protein and same residue as index &#39;</span><span class="si">{</span><span class="n">qmol_3</span><span class="o">.</span><span class="n">serial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">qmol_3</span><span class="o">.</span><span class="n">serial</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                      <span class="n">style</span><span class="o">=</span><span class="s1">&#39;NewCartoon&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">4</span><span class="p">);</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catch_bb_clashes</span><span class="p">(</span><span class="n">chim</span><span class="p">,</span> <span class="n">qmol_1</span><span class="p">,</span> <span class="n">smol_2</span><span class="p">,</span> <span class="n">qmol_3</span><span class="p">)</span>
            <span class="c1">#self.check_bb_clashes(chim)</span>
        <span class="k">except</span> <span class="n">BbClashError</span><span class="p">:</span>
            <span class="c1">#logger.warning(f&quot;comb{combnum}_{index1}_{index2} present backbone clashes&quot;)</span>
            <span class="k">raise</span> <span class="n">BbClashError</span>

        <span class="n">cut1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">smol_2</span><span class="o">.</span><span class="n">resid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cut2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">smol_2</span><span class="o">.</span><span class="n">resid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">chim</span><span class="p">,</span> <span class="p">[</span><span class="n">cut1</span><span class="p">,</span> <span class="n">cut2</span><span class="p">]</span>

<div class="viewcode-block" id="Builder.build_insert"><a class="viewcode-back" href="../../builder.html#builder.builder.Builder.build_insert">[docs]</a>    <span class="k">def</span> <span class="nf">build_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partial_alignment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cutoff_distance</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        #TODO for now implemented only to be GLOBAL ALIGNMENT</span>
<span class="sd">        #TODO NEEDS TESTING - still working with resids</span>
<span class="sd">        #TODO perhaps is a good idea to follow this algorithm for the single crossover chimeras</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You need to align the structures before building the chimeras&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">recombinations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">outcomes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Query crossovers&#39;</span><span class="p">,</span> <span class="s1">&#39;Subject crossovers&#39;</span><span class="p">,</span> <span class="s1">&#39;Not enough mutations&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Not enough mutations Subject N-terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;Backbone clash&#39;</span><span class="p">,</span> <span class="s1">&#39;Connection gap&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">outcomes</span><span class="p">,</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">))]))</span>

        <span class="k">if</span> <span class="n">partial_alignment</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">qpairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_qpairs</span>
            <span class="n">spairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_spairs</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_dst</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qpairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpairs</span>
            <span class="n">spairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spairs</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dst</span>

        <span class="n">combs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fusion_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">cutoff_distance</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">fusion_points</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">combs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="n">q_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qPDB</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;protein and name CA&quot;</span><span class="p">)</span>

        <span class="n">s_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sPDB</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s2">&quot;protein and name CA&quot;</span><span class="p">)</span>

        <span class="n">qMOL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qaPDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sMOL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saPDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">qMOL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_serials</span><span class="p">(</span><span class="n">qMOL</span><span class="p">)</span>
        <span class="n">sMOL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_serials</span><span class="p">(</span><span class="n">sMOL</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">crossovers</span> <span class="ow">in</span> <span class="n">combs</span><span class="p">:</span>

            <span class="n">xo_query_1</span> <span class="o">=</span> <span class="n">qpairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">crossovers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="n">xo_query_2</span> <span class="o">=</span> <span class="n">qpairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">crossovers</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="n">xo_subject_1</span> <span class="o">=</span> <span class="n">spairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">crossovers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="n">xo_subject_2</span> <span class="o">=</span> <span class="n">spairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">crossovers</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">recomb1</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_recombination</span><span class="p">(</span><span class="n">qMOL</span><span class="p">,</span> <span class="n">sMOL</span><span class="p">,</span> <span class="n">crossovers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crossovers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                             <span class="n">xo_query_1</span><span class="p">,</span> <span class="n">xo_query_2</span><span class="p">,</span>
                                                             <span class="n">xo_subject_1</span><span class="p">,</span> <span class="n">xo_subject_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">recombinations</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;comb1_</span><span class="si">{</span><span class="n">cut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cut</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recomb1</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Query crossovers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xo_query_1</span><span class="p">,</span> <span class="n">xo_query_2</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Subject crossovers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xo_subject_1</span><span class="p">,</span> <span class="n">xo_subject_2</span><span class="p">))</span>

            <span class="k">except</span> <span class="n">NotDiverseChimeraError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Not enough mutations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">crossovers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crossovers</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">except</span> <span class="n">BbClashError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Backbone clash&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">crossovers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crossovers</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="c1">#except ConnectionGapError:</span>
            <span class="c1">#    self.chim_positions[&#39;Connection gap&#39;].append((crossovers[0], crossovers[1]))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">recomb2</span><span class="p">,</span> <span class="n">cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_recombination</span><span class="p">(</span><span class="n">sMOL</span><span class="p">,</span> <span class="n">qMOL</span><span class="p">,</span> <span class="n">crossovers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crossovers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                             <span class="n">xo_subject_1</span><span class="p">,</span> <span class="n">xo_subject_2</span><span class="p">,</span>
                                                             <span class="n">xo_query_1</span><span class="p">,</span> <span class="n">xo_query_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">recombinations</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;comb2_</span><span class="si">{</span><span class="n">cut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cut</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recomb2</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Query crossovers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xo_query_1</span><span class="p">,</span> <span class="n">xo_query_2</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Subject crossovers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xo_subject_1</span><span class="p">,</span> <span class="n">xo_subject_2</span><span class="p">))</span>

            <span class="k">except</span> <span class="n">NotDiverseChimeraError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Not enough mutations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">crossovers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crossovers</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">except</span> <span class="n">BbClashError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chim_positions</span><span class="p">[</span><span class="s1">&#39;Backbone clash&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">crossovers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crossovers</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="c1">#except ConnectionGapError:</span>
            <span class="c1">#    self.chim_positions[&#39;Connection gap&#39;].append((crossovers[0], crossovers[1]))</span>

        <span class="k">return</span> <span class="n">recombinations</span></div>

    <span class="k">def</span> <span class="nf">write_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">recombs</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pdb</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ERROR! </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> was not assigned&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recombs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">pdb</span> <span class="o">==</span> <span class="kc">True</span> <span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.pdb&#39;</span><span class="p">))</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Noelia Ferruz.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>